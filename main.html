<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crypa - Chat</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Mona+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --bg-color: #151d2a;
            --surface-color: #1e2a3a;
            --surface-light: #2a384a;
            --primary-color: #4f8aff;
            --on-primary: #ffffff;
            --text-primary: #ffffff;
            --text-secondary: #a0aab5;
            --error-color: #ff4d4d;
            --success-color: #00e676;
            --read-color: #00e676;
            --delivered-color: #4f8aff;
            --sent-color: #a0aab5;
            --input-bg: #0f1621;
            --border-radius: 12px;
            --nav-height: 70px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            scrollbar-width: none;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Utilities */
        .hidden { display: none !important; }
        .fade-out { opacity: 0; pointer-events: none; }
        
        /* Bottom Navigation */
        .bottom-nav {
            height: var(--nav-height);
            background-color: var(--surface-color);
            border-top: 1px solid rgba(255,255,255,0.05);
            display: flex;
            justify-content: space-around;
            align-items: center;
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            cursor: pointer;
            width: 25%;
            height: 100%;
            transition: color 0.2s;
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .nav-item i {
            font-size: 1.6rem;
            margin-bottom: 4px;
        }

        .nav-item span {
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            position: relative;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }

        /* Chat List View */
        #chat-list-view {
            width: 100%;
            height: 100%;
            padding: 20px;
            padding-bottom: 90px;
            overflow-y: auto;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .page-title {
            font-family: 'Mona Sans', sans-serif;
            font-size: 1.8rem;
            font-weight: 600;
        }

        .icon-btn {
            background: var(--surface-light);
            border: none;
            color: var(--text-primary);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .icon-btn:hover { background: rgba(255,255,255,0.1); }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 60%;
            color: var(--text-secondary);
            text-align: center;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.2;
        }

        .chat-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: var(--surface-color);
            border-radius: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .chat-item:hover { background: var(--surface-light); }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            background-color: var(--surface-light);
        }

        .chat-info {
            flex: 1;
            overflow: hidden;
        }

        .chat-name {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 1rem;
        }

        .chat-last-msg {
            color: var(--text-secondary);
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Chat Room View */
        #chat-room-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            z-index: 200;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        #chat-room-view.active {
            transform: translateY(0);
        }

        .chat-header {
            padding: 15px 20px;
            background: rgba(30, 42, 58, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            z-index: 10;
        }

        .back-btn {
            margin-right: 15px;
            cursor: pointer;
            color: var(--text-primary);
        }

        .user-pill {
            display: flex;
            align-items: center;
            background: var(--surface-light);
            padding: 6px 12px;
            border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .pill-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .pill-info {
            display: flex;
            flex-direction: column;
        }

        .pill-name { font-weight: 600; font-size: 0.9rem; }
        .pill-email { font-size: 0.7rem; color: var(--text-secondary); }

        .add-btn-header {
            margin-left: auto;
            background: transparent;
            border: none;
            color: var(--primary-color);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }

        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message-bubble {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            font-size: 0.95rem;
            line-height: 1.4;
            animation: popIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            cursor: pointer;
        }

        @keyframes popIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .message-bubble.sent {
            align-self: flex-end;
            background-color: var(--primary-color);
            color: var(--on-primary);
            border-bottom-right-radius: 4px;
        }

        .message-bubble.received {
            align-self: flex-start;
            background-color: var(--surface-light);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
        }

        .msg-file {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 5px;
        }

        .msg-file i { font-size: 1.5rem; }
        
        .msg-img {
            max-width: 100%;
            border-radius: 8px;
            margin-bottom: 5px;
            display: block;
        }

        .msg-meta {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 5px;
            font-size: 0.7rem;
            margin-top: 4px;
            opacity: 0.8;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-dot.sent { background-color: var(--sent-color); }
        .status-dot.delivered { background-color: var(--delivered-color); }
        .status-dot.read { background-color: var(--read-color); }

        .msg-options-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background: rgba(0,0,0,0.5);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            cursor: pointer;
        }

        .message-bubble:hover .msg-options-btn { display: flex; }

        .message-bubble.recalled {
            background-color: transparent;
            color: var(--text-secondary);
            font-style: italic;
            font-size: 0.8rem;
            padding: 5px;
            align-self: center;
        }
        .message-bubble.recalled .msg-options-btn { display: none; }

        /* Input Area */
        .input-area {
            padding: 10px 15px;
            background: var(--surface-color);
            display: flex;
            align-items: flex-end;
            gap: 10px;
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        .attach-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.4rem;
            padding: 10px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .attach-btn:hover { color: var(--primary-color); }

        .msg-input {
            flex: 1;
            background: var(--input-bg);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            resize: none;
            max-height: 120px;
            outline: none;
            overflow-y: hidden;
            min-height: 44px;
        }

        .send-btn {
            background: var(--primary-color);
            border: none;
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(79, 138, 255, 0.3);
            transition: transform 0.1s;
        }

        .send-btn:active { transform: scale(0.95); }

        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            z-index: 300;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .modal.open { transform: translateY(0); }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
        }

        .modal-title { font-family: 'Mona Sans', sans-serif; font-size: 1.5rem; }
        .close-modal { margin-left: auto; cursor: pointer; font-size: 1.5rem; }

        .modal-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            background: var(--input-bg);
            border: 1px solid rgba(255,255,255,0.05);
            padding: 14px;
            border-radius: 14px;
            color: white;
            font-family: 'Inter', sans-serif;
            outline: none;
        }

        .qr-btn {
            background: var(--surface-light);
            border: none;
            color: white;
            padding: 0 20px;
            border-radius: 14px;
            cursor: pointer;
        }

        .user-preview {
            background: var(--surface-color);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            display: none;
            flex-direction: column;
            align-items: center;
        }

        .preview-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 15px;
        }

        .preview-name { font-weight: 600; font-size: 1.2rem; margin-bottom: 5px; }
        .preview-email { color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 20px; }

        .msg-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
        }

        .context-menu {
            position: absolute;
            background: var(--surface-light);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            z-index: 500;
            display: none;
            flex-direction: column;
            width: 120px;
            overflow: hidden;
        }

        .context-item {
            padding: 12px 16px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .context-item:hover { background: rgba(255,255,255,0.05); }
        .context-item.danger { color: var(--error-color); }

        #file-input { display: none; }

    </style>
</head>
<body>

    <div class="main-content">
        <!-- Chat List -->
        <div id="chat-list-view">
            <div class="header-row">
                <div class="page-title">Chats</div>
                <button class="icon-btn" id="btn-new-chat">
                    <i class="material-icons">add</i>
                </button>
            </div>
            
            <div id="chats-container">
                <!-- Chat items will be injected here -->
            </div>
            
            <div id="empty-chats" class="empty-state">
                <i class="material-icons">chat_bubble_outline</i>
                <p>No Messages To See Here</p>
            </div>
        </div>

        <!-- Chat Room -->
        <div id="chat-room-view">
            <div class="chat-header">
                <div class="back-btn" id="btn-back-chat">
                    <i class="material-icons">arrow_back</i>
                </div>
                <div class="user-pill">
                    <img src="" alt="" class="pill-avatar" id="current-chat-avatar">
                    <div class="pill-info">
                        <span class="pill-name" id="current-chat-name">User</span>
                        <span class="pill-email" id="current-chat-email">email</span>
                    </div>
                </div>
                <button class="add-btn-header" id="btn-attach-file">
                    <i class="material-icons">add_circle_outline</i>
                </button>
            </div>
            
            <div class="messages-area" id="messages-area">
                <!-- Messages injected here -->
            </div>

            <div class="input-area">
                <input type="file" id="file-input">
                <button class="attach-btn" id="btn-attach-trigger">
                    <i class="material-icons">add</i>
                </button>
                <textarea class="msg-input" id="msg-input" placeholder="Message..." rows="1"></textarea>
                <button class="send-btn" id="btn-send">
                    <i class="material-icons">send</i>
                </button>
            </div>
        </div>
    </div>

    <!-- Bottom Nav -->
    <div class="bottom-nav" id="bottom-nav">
        <div class="nav-item active">
            <i class="material-icons">chat</i>
            <span>Chat</span>
        </div>
        <div class="nav-item">
            <i class="material-icons">smart_toy</i>
            <span>AI</span>
        </div>
        <div class="nav-item">
            <i class="material-icons">feed</i>
            <span>Feed</span>
        </div>
        <div class="nav-item">
            <i class="material-icons">person</i>
            <span>Profile</span>
        </div>
    </div>

    <!-- New Chat Modal -->
    <div class="modal" id="new-chat-modal">
        <div class="modal-header">
            <div class="modal-title">New Chat</div>
            <div class="close-modal" id="btn-close-modal">&times;</div>
        </div>
        <div class="modal-body">
            <div class="search-box">
                <input type="text" class="search-input" id="username-search" placeholder="Enter username...">
                <button class="qr-btn"><i class="material-icons">qr_code_scanner</i></button>
            </div>
            <div class="user-preview" id="user-preview">
                <img src="" class="preview-avatar" id="preview-avatar">
                <div class="preview-name" id="preview-name">Name</div>
                <div class="preview-email" id="preview-email">Email</div>
                <button class="msg-btn" id="btn-start-chat">Message</button>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="context-menu">
        <div class="context-item danger" id="ctx-recall">Recall Message</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, update, get, child } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAAy3uUW0adMIMfPVRZXZkOHipi3y1v7gs",
            authDomain: "crypa-f60b0.firebaseapp.com",
            databaseURL: "https://crypa-f60b0-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "crypa-f60b0",
            storageBucket: "crypa-f60b0.firebasestorage.app",
            messagingSenderId: "504499957380",
            appId: "1:504499957380:web:0dd3cb2e0f9fd15a451cd1",
            measurementId: "G-TVX60TVN7S"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let currentUser = null;
        let currentChatId = null;
        let otherUserUid = null;

        // UI Elements
        const chatListView = document.getElementById('chat-list-view');
        const chatRoomView = document.getElementById('chat-room-view');
        const bottomNav = document.getElementById('bottom-nav');
        const chatsContainer = document.getElementById('chats-container');
        const emptyChats = document.getElementById('empty-chats');
        const messagesArea = document.getElementById('messages-area');
        const msgInput = document.getElementById('msg-input');
        const fileInput = document.getElementById('file-input');
        const newChatModal = document.getElementById('new-chat-modal');
        const contextMenu = document.getElementById('context-menu');

        // Helper: Hashing
        async function hashString(str) {
            const msgBuffer = new TextEncoder().encode(str);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Helper: Auto-grow input
        msgInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // Auth Check
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadChats();
            } else {
                window.location.href = 'index.html'; // Redirect to login if not auth
            }
        });

        // Load Chats
        function loadChats() {
            const userChatsRef = ref(db, `user_chats/${currentUser.uid}`);
            onValue(userChatsRef, (snapshot) => {
                chatsContainer.innerHTML = '';
                const data = snapshot.val();
                if (!data) {
                    emptyChats.style.display = 'flex';
                    return;
                }
                emptyChats.style.display = 'none';
                
                const chatIds = Object.keys(data).sort((a,b) => data[b].timestamp - data[a].timestamp);

                chatIds.forEach(chatId => {
                    const chatInfo = data[chatId];
                    createChatItem(chatId, chatInfo);
                });
            });
        }

        function createChatItem(chatId, info) {
            const div = document.createElement('div');
            div.className = 'chat-item';
            // Assuming we stored the 'otherUserUid' in metadata or we derive it. 
            // For simplicity, let's fetch chat details to get the other user's info
            get(ref(db, `chats/${chatId}`)).then(snap => {
                const chatData = snap.val();
                if(!chatData) return;
                
                const otherId = chatData.members.find(m => m !== currentUser.uid);
                get(ref(db, `users/${otherId}`)).then(uSnap => {
                    const uData = uSnap.val();
                    div.innerHTML = `
                        <img src="${uData.avatar}" class="chat-avatar">
                        <div class="chat-info">
                            <div class="chat-name">${uData.username}</div>
                            <div class="chat-last-msg">${info.lastMessage}</div>
                        </div>
                    `;
                    div.onclick = () => openChat(chatId, uData);
                    chatsContainer.appendChild(div);
                });
            });
        }

        // New Chat Search
        document.getElementById('btn-new-chat').onclick = () => {
            newChatModal.classList.add('open');
        };

        document.getElementById('btn-close-modal').onclick = () => {
            newChatModal.classList.remove('open');
        };

        document.getElementById('username-search').addEventListener('keyup', async (e) => {
            if (e.key === 'Enter') {
                const username = e.target.value.trim();
                // Simple lookup by username (assuming unique usernames stored in 'usernames' node)
                get(ref(db, `usernames/${username}`)).then(snap => {
                    if (snap.exists()) {
                        const uid = Object.keys(snap.val())[0]; // Actually structure is usernames/{username}: true or uid. Let's fix lookup.
                        // Wait, previous code stored usernames as `usernames/{username}: true` or similar.
                        // Let's assume we have `usernames/{username}: uid` for reverse lookup if not, we iterate.
                        // For now, let's assume standard Firebase Auth lookup isn't enough, we need DB lookup.
                        // I will assume the previous registration created a `usernames` node mapping name->uid.
                    } else {
                        // Fallback: query users if direct lookup fails (less efficient but works for demo)
                        // This is a simplified version.
                    }
                });
            }
        });

        // Improved Search logic based on previous structure
        document.getElementById('username-search').addEventListener('input', async (e) => {
            const query = e.target.value.trim().toLowerCase();
            if(query.length < 3) {
                document.getElementById('user-preview').style.display = 'none';
                return;
            }
            
            // Fetching all users is bad for scale, but fine for demo. 
            // Ideally, index usernames.
            const usersRef = ref(db, 'users');
            const snapshot = await get(usersRef);
            let found = null;
            
            snapshot.forEach(childSnap => {
                if (childSnap.val().username.toLowerCase() === query) {
                    found = { uid: childSnap.key, ...childSnap.val() };
                }
            });

            if (found && found.uid !== currentUser.uid) {
                document.getElementById('preview-avatar').src = found.avatar;
                document.getElementById('preview-name').innerText = found.username;
                document.getElementById('preview-email').innerText = found.email;
                document.getElementById('user-preview').style.display = 'flex';
                document.getElementById('btn-start-chat').onclick = () => startChat(found);
            } else {
                document.getElementById('user-preview').style.display = 'none';
            }
        });

        async function startChat(targetUser) {
            // Determine Chat ID
            const ids = [currentUser.uid, targetUser.uid].sort();
            const chatId = ids.join('_');
            
            // Create Chat Node if not exists
            await set(ref(db, `chats/${chatId}`), {
                members: ids,
                timestamp: Date.now()
            });

            openChat(chatId, targetUser);
            newChatModal.classList.remove('open');
        }

        function openChat(chatId, targetUser) {
            currentChatId = chatId;
            otherUserUid = targetUser.uid;

            // UI Transition
            chatRoomView.classList.add('active');
            bottomNav.classList.add('fade-out');
            
            // Set Header
            document.getElementById('current-chat-avatar').src = targetUser.avatar;
            document.getElementById('current-chat-name').innerText = targetUser.username;
            document.getElementById('current-chat-email').innerText = targetUser.email;

            // Load Messages (Live Listener - "WebSocket" style via Firebase)
            const messagesRef = ref(db, `messages/${chatId}`);
            onValue(messagesRef, (snapshot) => {
                messagesArea.innerHTML = '';
                const data = snapshot.val();
                if(!data) return;

                Object.keys(data).sort().forEach(key => {
                    const msg = data[key];
                    renderMessage(key, msg);
                });
                scrollToBottom();
            });
        }

        function renderMessage(key, msg) {
            const isMe = msg.senderId === currentUser.uid;
            const div = document.createElement('div');
            div.className = `message-bubble ${isMe ? 'sent' : 'received'}`;
            
            if (msg.recalled) {
                div.classList.add('recalled');
                div.innerHTML = 'Message recalled';
                messagesArea.appendChild(div);
                return;
            }

            // Content
            let contentHtml = '';
            if (msg.type === 'text') {
                contentHtml = msg.content;
            } else if (msg.type === 'image') {
                contentHtml = `<img src="${msg.content}" class="msg-img">`;
            } else if (msg.type === 'file') {
                contentHtml = `
                    <div class="msg-file">
                        <i class="material-icons">description</i>
                        <span>${msg.fileName || 'Document'}</span>
                    </div>
                `;
            }

            // Time & Status
            const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            let statusClass = 'sent';
            if (msg.status === 'delivered') statusClass = 'delivered';
            if (msg.status === 'read') statusClass = 'read';

            div.innerHTML = `
                ${contentHtml}
                <div class="msg-meta">
                    <span>${time}</span>
                    ${isMe ? `<span class="status-dot ${statusClass}"></span>` : ''}
                </div>
                ${isMe ? `<div class="msg-options-btn"><i class="material-icons" style="font-size:14px">more_vert</i></div>` : ''}
            `;

            // Recall Logic
            if (isMe && !msg.recalled) {
                const optionsBtn = div.querySelector('.msg-options-btn');
                optionsBtn.onclick = (e) => {
                    e.stopPropagation();
                    showContextMenu(e.clientX, e.clientY, key);
                };
            }

            messagesArea.appendChild(div);
        }

        function scrollToBottom() {
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        // Send Message
        document.getElementById('btn-send').onclick = sendMessage;
        msgInput.onkeydown = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        };

        async function sendMessage(fileData = null, fileType = 'text', fileName = '') {
            const text = msgInput.value.trim();
            if (!text && !fileData) return;

            const contentHash = fileData ? await hashString(fileData) : await hashString(text);
            
            const msgData = {
                senderId: currentUser.uid,
                content: fileData || text,
                timestamp: Date.now(),
                type: fileType,
                hash: contentHash,
                status: 'sent',
                recalled: false
            };

            if (fileType === 'file') msgData.fileName = fileName;

            const newMsgRef = push(ref(db, `messages/${currentChatId}`));
            await set(newMsgRef, msgData);

            // Update Chat List
            await update(ref(db, `user_chats/${currentUser.uid}/${currentChatId}`), {
                lastMessage: fileType === 'text' ? text : 'Sent a file',
                timestamp: Date.now()
            });
            // Update other user's chat list
            await update(ref(db, `user_chats/${otherUserUid}/${currentChatId}`), {
                lastMessage: fileType === 'text' ? text : 'Sent a file',
                timestamp: Date.now()
            });

            msgInput.value = '';
            msgInput.style.height = 'auto';
            
            // Simulate delivery for self (In real app, other client listens and updates 'delivered')
            // Here we just mark it delivered immediately for the UI demo flow or rely on the other client logic if multi-device.
            // For this single-page demo, we will mark it read if we could see it, but let's just leave it 'sent' until logic exists.
        }

        // File Handling
        document.getElementById('btn-attach-trigger').onclick = () => fileInput.click();
        document.getElementById('btn-attach-file').onclick = () => fileInput.click(); // Header button

        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (event) => {
                let type = 'file';
                if (file.type.startsWith('image/')) type = 'image';
                sendMessage(event.target.result, type, file.name);
            };
            reader.readAsDataURL(file);
        };

        // Back Button
        document.getElementById('btn-back-chat').onclick = () => {
            chatRoomView.classList.remove('active');
            bottomNav.classList.remove('fade-out');
            // Detach listener? optional for this simple SPA
        };

        // Context Menu (Recall)
        let selectedMsgKey = null;
        function showContextMenu(x, y, key) {
            selectedMsgKey = key;
            contextMenu.style.display = 'flex';
            contextMenu.style.left = x + 'px';
            contextMenu.style.top = y + 'px';
        }

        // Close menu on click outside
        document.addEventListener('click', (e) => {
            if (!contextMenu.contains(e.target) && !e.target.closest('.msg-options-btn')) {
                contextMenu.style.display = 'none';
            }
        });

        document.getElementById('ctx-recall').onclick = async () => {
            if (selectedMsgKey && currentChatId) {
                await update(ref(db, `messages/${currentChatId}/${selectedMsgKey}`), {
                    recalled: true,
                    content: null
                });
                // Update last message preview in list
                await update(ref(db, `user_chats/${currentUser.uid}/${currentChatId}`), {
                    lastMessage: 'Message recalled',
                    timestamp: Date.now()
                });
            }
            contextMenu.style.display = 'none';
        };

    </script>
</body>
</html>